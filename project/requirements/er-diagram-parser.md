# ER図パーサー要件定義書

## 1. 概要

### 1.1 目的
Mermaid形式で記述されたER図（Entity Relationship Diagram）を解析し、構造化されたJSON形式に変換するMCPツールを開発する。このツールは、ER図のエンティティ、属性、リレーションシップを抽出し、プログラムで処理可能な形式に変換することで、ドキュメントの自動生成、データベーススキーマの検証、設計情報の分析などに活用できる。

### 1.2 スコープ
- Mermaid ER図記法の解析
- エンティティ、属性、リレーションシップの抽出
- 構造化JSON形式への変換
- MCPツールとしての実装

## 2. 機能要件

### 2.1 入力処理

#### 2.1.1 入力形式
- Mermaid形式のER図テキストを文字列として受け取る
- UTF-8エンコーディングをサポート

#### 2.1.2 必須サポート記法

**リレーション記法**
- カーディナリティ記号
  - `|o` / `o|`：0または1（Zero or one）
  - `||` / `||`：正確に1（Exactly one）
  - `}o` / `o{`：0以上（Zero or more）
  - `}|` / `|{`：1以上（One or more）
- 識別タイプ
  - `--`：識別関係（実線）
  - `..`：非識別関係（破線）

**エンティティ定義**
- 基本的なエンティティ名（英数字、ハイフン、アンダースコア）
- 属性ブロック構文：`EntityName { ... }`

**属性定義**
- データ型：`string`, `int`, `float`, `boolean`, `date`
- 配列型：`string[]`, `int[]`
- 長さ制約付き型：`string(99)`, `varchar(5)`
- キー定義：`PK`, `FK`, `UK`
- コメント：二重引用符で囲まれたテキスト

### 2.2 解析処理

#### 2.2.1 エンティティ解析
- エンティティ名の抽出
- 属性情報の解析（名前、データ型、キー、コメント）
- 関連エンティティ（リレーションのみで定義）の認識

#### 2.2.2 リレーションシップ解析
- 始点エンティティと終点エンティティの識別
- カーディナリティの解釈
- リレーションラベルの抽出
- 識別/非識別関係の判定

#### 2.2.3 自然言語記法のサポート
- `one to zero or more`
- `many(0) optionally to 0+`
- その他のエイリアス記法

### 2.3 出力処理

#### 2.3.1 出力形式
構造化されたJSON形式で以下の情報を出力：

```json
{
  "entities": [
    {
      "name": "エンティティ名",
      "members": [
        {
          "name": "属性名",
          "dataType": "データ型",
          "keys": ["PK", "FK"],
          "comment": "コメント"
        }
      ]
    }
  ],
  "relationships": [
    {
      "from": "始点エンティティ",
      "to": "終点エンティティ",
      "left": "カーディナリティ（英語表記）",
      "right": "カーディナリティ（英語表記）",
      "label": "リレーションラベル",
      "type": "identifying | non-identifying"
    }
  ],
  "metadata": {
    "title": "ダイアグラムタイトル",
    "direction": "TB | BT | LR | RL"
  }
}
```

#### 2.3.2 カーディナリティの英語表記変換
- `|o` / `o|` → "zero or one"
- `||` / `||` → "exactly one"
- `}o` / `o{` → "zero or more"
- `}|` / `|{` → "one or more"

### 2.4 オプション機能

以下の機能は将来的な拡張として検討：
- エンティティエイリアス（`p[Person]`）のサポート
- Unicode文字、Markdownフォーマットのサポート
- カスタムデータ型のサポート
- ジェネリック型（`type~T~`）のサポート
- 複数ブロックでの同一エンティティ定義のサポート

## 3. 非機能要件

### 3.1 性能要件
- 1000エンティティ、5000リレーションシップを含むER図を10秒以内に処理
- メモリ使用量は入力サイズの10倍以内

### 3.2 信頼性要件
- 不正な入力に対して適切なエラーメッセージを返す
- パース中にエラーが発生しても、可能な限り部分的な結果を返す

### 3.3 保守性要件
- テストカバレッジ100%を維持
- Feature-Sliced Design（FSD）アーキテクチャに準拠
- TypeScriptの型安全性を最大限活用

## 4. 入出力仕様

### 4.1 入力パラメータ

```typescript
interface ParseErDiagramParams {
  mermaidText: string;  // Mermaid形式のER図テキスト
  options?: {
    includeMetadata?: boolean;  // メタデータを含むか（デフォルト: true）
    strictMode?: boolean;       // 厳密モード（デフォルト: false）
  };
}
```

### 4.2 出力形式

```typescript
interface ErDiagramParseResult {
  entities: Entity[];
  relationships: Relationship[];
  metadata?: Metadata;
}

interface Entity {
  name: string;
  members?: Member[];
}

interface Member {
  name: string;
  dataType: string;
  keys?: KeyType[];
  comment?: string;
}

type KeyType = "PK" | "FK" | "UK";

interface Relationship {
  from: string;
  to: string;
  left: Cardinality;
  right: Cardinality;
  label?: string;
  type: "identifying" | "non-identifying";
}

type Cardinality = "zero or one" | "exactly one" | "zero or more" | "one or more";

interface Metadata {
  title?: string;
  direction?: "TB" | "BT" | "LR" | "RL";
}
```

## 5. 制約事項

### 5.1 構文制約
- リレーション文では、first-entity以外のすべての部分が必須
- コメント内に二重引用符を含めることはできない
- キー定義（PK, FK, UK）ではMarkdownフォーマットとUnicodeはサポートされない

### 5.2 処理制約
- 循環参照のあるER図も正常に処理する
- エンティティ名の大文字・小文字は区別する
- 重複するエンティティ定義は最後の定義で上書きする

## 6. エラーハンドリング

### 6.1 エラーケース
- 空の入力
- 無効なMermaid構文
- 不完全なリレーション定義
- 無効なカーディナリティ記号
- 存在しないエンティティへの参照

### 6.2 エラー出力形式

```typescript
interface ParseError {
  code: string;
  message: string;
  line?: number;
  column?: number;
  details?: any;
}
```

## 7. テスト要件

### 7.1 正常系テストケース

#### 7.1.1 基本機能テスト（既存5ケース）
1. **基本的なリレーションシップ**
   - 複数エンティティ間のリレーション定義
   - タイトル定義を含むER図
   - ハイフン付きエンティティ名の処理

2. **エンティティ属性定義**
   - 基本データ型（string, int, float）
   - 属性ブロック付きエンティティ

3. **関連エンティティ**
   - リレーションのみで定義されるエンティティ
   - 多対多の関係を解決する中間エンティティ

4. **自然言語記法**
   - `one to zero or more`
   - `many(0) optionally to 0+`

5. **複雑な属性定義**
   - 配列型、長さ制約付き型
   - PK/FK/UK キー定義
   - コメント付き属性

#### 7.1.2 追加テストケース
6. **全カーディナリティ組み合わせ**
   - `|o--||`：0または1対正確に1
   - `|o..|o`：0または1対0または1（非識別）
   - `||..||`：正確に1対正確に1（非識別）
   - `}o--|{`：0以上対1以上（識別）

7. **拡張データ型**
   - `boolean`, `date`, `timestamp`
   - `varchar(5)`, `character(20)`, `numeric(4,2)`
   - カスタム型：`timestamp with time zone`

8. **特殊機能**
   - ダイアグラム方向指定（`direction TB/BT/LR/RL`）
   - エンティティエイリアス（`p[Person]`）
   - 空白を含むエンティティ名（二重引用符囲み）

### 7.2 異常系テストケース

#### 7.2.1 構文エラー
1. **空入力・無効な入力**
   - 空文字列
   - `erDiagram`キーワードなし
   - 不正なMermaid構文

2. **不完全なリレーション定義**
   - リレーションラベルなし
   - 片側のカーディナリティのみ
   - 存在しないエンティティへの参照

3. **無効なカーディナリティ記号**
   - `><`、`-->`などの無効な記号
   - 記号の組み合わせミス

4. **属性定義エラー**
   - データ型なしの属性
   - 二重引用符を含むコメント
   - 無効なキータイプ

#### 7.2.2 論理エラー
5. **重複定義**
   - 同一エンティティの複数定義
   - 同一属性名の重複
   - 同一リレーションの重複

6. **循環参照**
   - 自己参照リレーション
   - 複数エンティティ間の循環参照

### 7.3 境界値テストケース

#### 7.3.1 サイズ制限
1. **大規模ER図**
   - 1000エンティティ
   - 5000リレーションシップ
   - 10000属性

2. **文字列長制限**
   - 255文字のエンティティ名
   - 1000文字のコメント
   - 100文字のデータ型定義

#### 7.3.2 特殊文字
3. **Unicode文字**
   - 日本語エンティティ名
   - 絵文字を含むラベル
   - 特殊記号（数学記号等）

4. **エスケープ文字**
   - バックスラッシュ
   - 改行文字
   - タブ文字

### 7.4 性能テストケース

1. **処理時間測定**
   - 100エンティティ：1秒以内
   - 500エンティティ：5秒以内
   - 1000エンティティ：10秒以内

2. **メモリ使用量測定**
   - 入力サイズに対するメモリ使用量の線形性
   - メモリリークの確認

## 8. 今後の拡張計画

### Phase 1（MVP）
- 基本的なER図解析機能
- 必須記法のサポート
- JSON出力

### Phase 2
- エンティティエイリアスのサポート
- より多様なデータ型のサポート
- エラーハンドリングの改善

### Phase 3
- Unicode・Markdownサポート
- カスタムデータ型
- 複数ブロックエンティティ定義
- バリデーション機能の追加